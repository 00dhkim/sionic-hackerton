<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Graph RAG Explorer</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --card: #1e293b;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --border: #1f2937;
      --text: #e2e8f0;
      --surface: #0b1222;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(145deg, #0b1222, #0f172a);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 32px 24px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    header h1 { margin: 0; font-size: 28px; letter-spacing: -0.3px; }
    header p { margin: 0; color: var(--muted); }
    main { padding: 0 24px 40px; display: grid; gap: 16px; }
    section.card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }
    section.card h2 { margin: 0 0 8px; font-size: 18px; }
    .flex { display: flex; gap: 12px; flex-wrap: wrap; }
    .examples { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .example-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .example-btn:hover {
      background: rgba(56, 189, 248, 0.1);
      color: var(--accent);
      border-color: var(--accent);
    }
    .input {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      padding: 12px;
      width: 100%;
      resize: vertical;
      min-height: 60px;
    }
    .button {
      background: linear-gradient(120deg, #2563eb, #22d3ee);
      border: none;
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(34, 211, 238, 0.25);
      transition: transform 0.08s ease-in-out, box-shadow 0.08s ease-in-out;
    }
    .button:hover { transform: translateY(-1px); box-shadow: 0 12px 30px rgba(34, 211, 238, 0.35); }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .answer {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      min-height: 80px;
    }
    .context-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 10px;
    }
    .context-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
    }
    .context-card h4 { margin: 0 0 6px; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.1);
      color: #38bdf8;
      border: 1px solid rgba(56, 189, 248, 0.3);
      margin-right: 6px;
    }
    .muted { color: var(--muted); font-size: 14px; }
    #graph {
      width: 100%;
      height: 520px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      user-select: none;
    }
    .legend { display: flex; gap: 10px; flex-wrap: wrap; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .legend span { display: inline-flex; align-items: center; gap: 6px; }
    .legend .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .error { color: #fb7185; font-weight: 600; }
    .small { font-size: 13px; color: var(--muted); }
    .node-group.highlight circle { 
      stroke: #facc15 !important; 
      stroke-width: 6px !important;
      filter: drop-shadow(0 0 12px #facc15);
    }
    .node-label {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      font-size: 11px;
      fill: #e2e8f0;
      text-anchor: middle;
    }
    /* Show label on hover, when node has active class (clicked), or when highlighted */
    .node-group:hover .node-label,
    .node-group.active .node-label,
    .node-group.highlight .node-label {
      opacity: 1;
    }
     .link-label {
       display: none; /* Always hide relationship labels */
     }
     
     #abTestSection {
       border-color: #38bdf8;
     }
     
     #abTestSection h2 {
       color: #38bdf8;
     }
    /* Force show node labels only when the parent has show-all-labels class */
    #graph.show-all-labels .node-label {
      opacity: 1;
    }
    .graph-link { stroke: #475569; stroke-width: 1.2px; opacity: 0.7; }
    .graph-link.highlight-link {
      stroke: #facc15 !important;
      stroke-width: 2px !important;
      opacity: 0.9 !important;
      filter: drop-shadow(0 0 2px #facc15);
    }
  </style>
</head>
<body>
  <header>
    <h1>ì„œìš¸ì‹œ ì²­ë…„ì •ì±… Graph RAG ëŒ€ì‹œë³´ë“œ</h1>
    <p>ë¯¼ì›Â·ê³µë¬¸ì„œ GraphDBì™€ ì—°ë™ëœ ê²€ìƒ‰, ë¬¸ë§¥, ê·¸ë˜í”„ ì‹œê°í™”ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>
  </header>

  <main>
    <section class="card">
      <h2>ì§ˆë¬¸ ì…ë ¥</h2>
      <form id="queryForm">
        <div class="flex">
          <textarea id="queryInput" class="input" placeholder="ì˜ˆ) ì§€ê¸‰ì´ ì¤‘ë‹¨ëœ ë¯¼ì›ê³¼ ê´€ë ¨ ê·¼ê±° ë¬¸ì„œë¥¼ ì•Œë ¤ì¤˜" required></textarea>
        </div>
        <div class="examples">
          <button type="button" class="example-btn">ì²­ë…„ìˆ˜ë‹¹ ì‚¬ì—…ì—ì„œ ì–´ë–¤ ë¯¼ì›ì´ ë§ì´ ë‚˜ì˜¤ëŠ”ì§€ ì•Œë ¤ì¤˜</button>
          <button type="button" class="example-btn">ì–´ëŠ ë¬¸ì„œì™€ ê´€ë ¨ëœ ë¯¼ì›ì´ ë§ì€ì§€ ì•Œë ¤ì¤˜</button>
          <button type="button" class="example-btn">ë‚´ë…„ ì²­ë…„ìˆ˜ë‹¹ ê´€ë ¨ ê³µê³ ê°€ ì–¸ì œ ë‚˜ì˜¬ì§€ ì•Œë ¤ì¤˜</button>
          <button type="button" class="example-btn">ìê¸°ì„±ì¥ê¸°ë¡ì„œ ì‘ì„±ì„ ê¹œë¹¡í–ˆëŠ”ë° ì²­ë…„ìˆ˜ë‹¹ ì§€ê¸‰ë°›ì„ ìˆ˜ ìˆì–´?</button>
          <button type="button" class="example-btn">ì²­ë…„ìˆ˜ë‹¹ ë¯¸ì„ ì •ê³¼ ê´€ë ¨ëœ ì´ì˜ì‹ ì²­ ì‚¬ë¡€ì™€ ëŒ€ì²˜ë²• ì•Œë ¤ì¤˜</button>
        </div>
         <div class="flex" style="justify-content: space-between; align-items: center; margin-top: 8px;">
           <div class="small" id="statusText">API ì„œë²„ì™€ ê·¸ë˜í”„ì— ì—°ê²° ì¤‘...</div>
           <div style="display: flex; gap: 12px; align-items: center;">
             <label class="small" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
               <input type="checkbox" id="useHyde"> HyDE ì‚¬ìš©
             </label>
             <label class="small" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
               <input type="checkbox" id="showABTest"> A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
             </label>
             <button type="submit" class="button" id="searchButton">ê²€ìƒ‰ ë° ê·¸ë˜í”„ ì—…ë°ì´íŠ¸</button>
           </div>
         </div>
       </form>
     </section>

    <section class="card">
      <h2>ë‹µë³€</h2>
      <div id="answerBox" class="answer">ê²€ìƒ‰ í›„ ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div id="hypotheticalDocBox" style="display: none; margin-top: 12px; padding: 12px; background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.2); border-radius: 10px;">
        <div class="small" style="color: var(--accent); margin-bottom: 6px;">ğŸ¤– HyDE ê°€ìƒ ë¬¸ì„œ (Hypothetical Document)</div>
        <div id="hypotheticalDocContent" class="muted" style="white-space: pre-wrap; font-size: 14px;"></div>
      </div>
    </section>

    <section class="card" id="abTestSection" style="display: none;">
      <h2>ğŸ“Š HyDE A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
      
      <!-- ë‹µë³€ ë¹„êµ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div>
          <h3 style="color: #94a3b8; margin: 0 0 12px;">ì¼ë°˜ ê²€ìƒ‰ ë‹µë³€ (Standard)</h3>
          <div id="standardAnswer" class="answer" style="min-height: 100px; max-height: 400px; overflow-y: auto;">ë°ì´í„° ì—†ìŒ</div>
        </div>
        <div>
          <h3 style="color: #38bdf8; margin: 0 0 12px;">HyDE ê²€ìƒ‰ ë‹µë³€</h3>
          <div id="hydeAnswer" class="answer" style="min-height: 100px; max-height: 400px; overflow-y: auto;">ë°ì´í„° ì—†ìŒ</div>
        </div>
      </div>
      
      <!-- ê²€ìƒ‰ ê²°ê³¼ ì†ŒìŠ¤ ë¹„êµ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
        <div>
          <h3 style="color: #94a3b8; margin: 0 0 12px;">ì¼ë°˜ ê²€ìƒ‰ ì†ŒìŠ¤ (Standard)</h3>
          <div id="standardSources" class="muted">ë°ì´í„° ì—†ìŒ</div>
        </div>
        <div>
          <h3 style="color: #38bdf8; margin: 0 0 12px;">HyDE ê²€ìƒ‰ ì†ŒìŠ¤</h3>
          <div id="hydeSources" class="muted">ë°ì´í„° ì—†ìŒ</div>
        </div>
      </div>
      <div id="abTestStats" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);"></div>
    </section>

    <section class="card">
      <h2>ê°€ì ¸ì˜¨ ì»¨í…ìŠ¤íŠ¸</h2>
      <div class="context-grid">
        <div>
          <h3>ë¯¼ì› (Complaint)</h3>
          <div id="complaintList" class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
        <div>
          <h3>ê³µë¬¸ì„œ (Document)</h3>
          <div id="documentList" class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <h2>ê·¸ë˜í”„ ì‹œê°í™”</h2>
        <div class="flex" style="align-items: center; gap: 16px;">
          <label class="small" style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--accent);">
            <input type="checkbox" id="toggleLabels"> ëª¨ë“  ë¼ë²¨ í‘œì‹œ
          </label>
          <div class="legend">
            <span><span class="dot" style="background:#2563eb"></span>Document</span>
            <span><span class="dot" style="background:#f97316"></span>Complaint</span>
            <span><span class="dot" style="background:#22c55e"></span>Person</span>
            <span><span class="dot" style="background:#a855f7"></span>Department</span>
          </div>
        </div>
      </div>
      <div class="small" id="graphInfo">ê·¸ë˜í”„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <svg id="graph"></svg>
    </section>
  </main>

  <script>
    const queryForm = document.getElementById('queryForm');
    const queryInput = document.getElementById('queryInput');
    const searchButton = document.getElementById('searchButton');
    const answerBox = document.getElementById('answerBox');
    const complaintList = document.getElementById('complaintList');
    const documentList = document.getElementById('documentList');
    const statusText = document.getElementById('statusText');
    const graphInfo = document.getElementById('graphInfo');
    const graphSvg = d3.select('#graph');
    const toggleLabels = document.getElementById('toggleLabels');
    const useHydeCheckbox = document.getElementById('useHyde');
    const showABTestCheckbox = document.getElementById('showABTest');
    const hypotheticalDocBox = document.getElementById('hypotheticalDocBox');
    const hypotheticalDocContent = document.getElementById('hypotheticalDocContent');
    const abTestSection = document.getElementById('abTestSection');
    const standardAnswerDiv = document.getElementById('standardAnswer');
    const hydeAnswerDiv = document.getElementById('hydeAnswer');
    const standardSourcesDiv = document.getElementById('standardSources');
    const hydeSourcesDiv = document.getElementById('hydeSources');
    const abTestStatsDiv = document.getElementById('abTestStats');

    toggleLabels.addEventListener('change', (e) => {
      graphSvg.classed('show-all-labels', e.target.checked);
    });
    
    // When A/B test checkbox is checked, also check HyDE
    showABTestCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        useHydeCheckbox.checked = true;
      }
    });
    
    // When HyDE checkbox is unchecked, also uncheck A/B test
    useHydeCheckbox.addEventListener('change', (e) => {
      if (!e.target.checked) {
        showABTestCheckbox.checked = false;
      }
    });

    const colors = {
      Document: '#2563eb',
      Complaint: '#f97316',
      Person: '#22c55e',
      Department: '#a855f7',
      default: '#94a3b8'
    };

    let graphState = { nodes: [], edges: [] };
    let simulation;

    async function fetchGraph() {
      graphInfo.textContent = 'ê·¸ë˜í”„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      try {
        const res = await fetch('/api/graph/overview');
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        graphState = data;
        renderGraph(data);
        graphInfo.textContent = `ë…¸ë“œ ${data.nodes.length}ê°œ, ê´€ê³„ ${data.edges.length}ê°œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`;
        statusText.textContent = 'ê·¸ë˜í”„/ê²€ìƒ‰ API ì—°ê²° ì™„ë£Œ';
      } catch (err) {
        graphInfo.textContent = 'ê·¸ë˜í”„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.';
        statusText.textContent = 'ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨';
        console.error(err);
      }
    }

    function renderGraph(data) {
      const width = graphSvg.node().clientWidth || 900;
      const height = graphSvg.node().clientHeight || 520;
      graphSvg.attr('width', width).attr('height', height);
      graphSvg.selectAll('*').remove();

      // Container for all graph elements to support zoom
      const container = graphSvg.append('g');

      // Add zoom behavior
      const zoom = d3.zoom()
        .scaleExtent([0.1, 8])
        .on('zoom', (event) => {
          container.attr('transform', event.transform);
        });

      graphSvg.call(zoom);

      const links = data.edges.map(d => ({ ...d }));
      const nodes = data.nodes.map(d => ({ ...d }));

      simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(140).strength(0.6))
        .force('charge', d3.forceManyBody().strength(-260))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));

      // Define arrow marker
      graphSvg.append('defs').append('marker')
        .attr('id', 'arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 15)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', '#475569');

      const link = container.append('g')
        .attr('stroke', '#475569')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('class', 'graph-link')
        .attr('marker-end', 'url(#arrow)');

      const linkLabel = container.append('g')
        .selectAll('text')
        .data(links)
        .join('text')
        .attr('class', 'link-label')
        .attr('font-size', 10)
        .attr('fill', '#94a3b8')
        .text(d => d.type);

      // Drag behavior
      const drag = d3.drag()
        .on('start', (event, d) => {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        })
        .on('drag', (event, d) => {
          d.fx = event.x;
          d.fy = event.y;
        })
        .on('end', (event, d) => {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        });

      // Node groups to contain circle and text
      const node = container.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .attr('class', 'node-group')
        .call(drag)
        .on('click', function() {
          const g = d3.select(this);
          const isActive = g.classed('active');
          g.classed('active', !isActive);
        });

      node.append('circle')
        .attr('r', 12)
        .attr('fill', d => colors[d.primary_label] || colors.default)
        .attr('stroke', '#0f172a')
        .attr('stroke-width', 1.5);

      node.append('title')
        .text(d => `${d.primary_label}: ${d.display || d.id}`);

      node.append('text')
        .attr('class', 'node-label')
        .attr('dy', -16)
        .text(d => d.display || d.primary_label);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        linkLabel
          .attr('x', d => (d.source.x + d.target.x) / 2)
          .attr('y', d => (d.source.y + d.target.y) / 2);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });
    }

    function renderContext(context) {
      complaintList.innerHTML = '';
      documentList.innerHTML = '';

      if (!context || (context.complaints?.length === 0 && context.documents?.length === 0)) {
        complaintList.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        documentList.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      if (context.complaints?.length) {
        context.complaints.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'context-card';
          card.innerHTML = `
            <div class="badge">Complaint #${item.id}</div>
            <div class="muted" style="white-space: pre-wrap; margin: 8px 0;">${item.content || item.snippet}</div>
            <div class="small" style="margin-top:8px; border-top: 1px solid var(--border); padding-top: 8px;">ì—°ê²°ëœ ê³µë¬¸ì„œ</div>
          `;
          const list = document.createElement('ul');
          list.className = 'small';
          if (item.related_documents.length === 0) {
            list.innerHTML = '<li class="muted">ì—°ê²°ëœ ê³µë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
          } else {
            item.related_documents.forEach(doc => {
              const li = document.createElement('li');
              const score = doc.similarity ? ` (score: ${doc.similarity.toFixed(3)})` : '';
              li.textContent = `${doc.title || 'ì œëª© ì—†ìŒ'} / ë‹´ë‹¹ì: ${doc.author || 'N/A'}${score}`;
              list.appendChild(li);
            });
          }
          card.appendChild(list);
          complaintList.appendChild(card);
        });
      } else {
        complaintList.textContent = 'ê²€ìƒ‰ëœ ë¯¼ì›ì´ ì—†ìŠµë‹ˆë‹¤.';
      }

      if (context.documents?.length) {
        context.documents.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'context-card';
          card.innerHTML = `
            <div class="badge">Document ${item.id}</div>
            <h4>${item.title}</h4>
            <div class="muted" style="white-space: pre-wrap; margin: 8px 0;">${item.content || item.snippet}</div>
          `;
          const meta = document.createElement('div');
          meta.className = 'small';
          const author = item.metadata?.author ? `ì‘ì„±ì: ${item.metadata.author}` : 'ì‘ì„±ì ì •ë³´ ì—†ìŒ';
          const dept = item.metadata?.department ? ` / ë¶€ì„œ: ${item.metadata.department}` : '';
          meta.innerHTML = `<div>${author}${dept}</div>`;

          const citations = document.createElement('div');
          citations.className = 'small';
          if (item.metadata?.citations?.length) {
            const citedTitles = item.metadata.citations.map(c => c.title).filter(Boolean).slice(0, 5);
            citations.innerHTML = `<div>ì¸ìš©: ${citedTitles.join(', ')}</div>`;
          } else {
            citations.innerHTML = '<div>ì¸ìš© ì •ë³´ ì—†ìŒ</div>';
          }
          card.appendChild(meta);
          card.appendChild(citations);
          documentList.appendChild(card);
        });
      } else {
        documentList.textContent = 'ê²€ìƒ‰ëœ ê³µë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.';
      }
    }

    function highlightGraphNodes(nodeIds = []) {
      if (!graphState.nodes.length) return;
      const idSet = new Set(nodeIds);
      const nodeGroups = graphSvg.selectAll('.node-group');
      
      nodeGroups.classed('highlight', d => idSet.has(d.id));
      
      // Highlight links where BOTH source and target are in the highlighted set
      graphSvg.selectAll('.graph-link')
        .classed('highlight-link', d => idSet.has(d.source.id) && idSet.has(d.target.id));
      
      // Bring highlighted nodes to front
      nodeGroups.filter('.highlight').raise();
    }

    async function handleSearch(event) {
      event.preventDefault();
      const query = queryInput.value.trim();
      if (!query) return;

      searchButton.disabled = true;
      statusText.textContent = 'ê²€ìƒ‰ ë° ì¶”ë¡  ì¤‘...';
      answerBox.textContent = 'ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

      // Hide hypothetical doc and AB test section initially
      hypotheticalDocBox.style.display = 'none';
      abTestSection.style.display = 'none';

      const useHyde = useHydeCheckbox.checked;
      const showABTest = showABTestCheckbox.checked;

      try {
        const res = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, use_hyde: useHyde })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        
        answerBox.textContent = data.answer || 'ë‹µë³€ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.';
        renderContext(data.context);
        highlightGraphNodes(data.highlighted_nodes || []);
        
        // Show hypothetical document if HyDE was used
        if (data.hypothetical_document) {
          hypotheticalDocContent.textContent = data.hypothetical_document;
          hypotheticalDocBox.style.display = 'block';
        }
        
        // Show A/B test results if enabled and data available
        if (showABTest && data.standard_search_sources) {
          renderABTestResults(data);
        }
        
        statusText.textContent = `ê²€ìƒ‰ ì™„ë£Œ (${data.search_method || 'Standard'})`;
      } catch (err) {
        answerBox.innerHTML = `<span class="error">ê²€ìƒ‰ ì‹¤íŒ¨: ${err.message}</span>`;
        statusText.textContent = 'ê²€ìƒ‰ ì‹¤íŒ¨';
        console.error(err);
      } finally {
        searchButton.disabled = false;
      }
    }

    function renderABTestResults(data) {
      abTestSection.style.display = 'block';
      
      // Render Standard Answer
      const standardAnswerDiv = document.getElementById('standardAnswer');
      if (data.standard_answer) {
        standardAnswerDiv.textContent = data.standard_answer;
      } else {
        standardAnswerDiv.innerHTML = '<div class="muted">ë‹µë³€ ì—†ìŒ</div>';
      }
      
      // Render HyDE Answer
      const hydeAnswerDiv = document.getElementById('hydeAnswer');
      if (data.answer) {
        hydeAnswerDiv.textContent = data.answer;
      } else {
        hydeAnswerDiv.innerHTML = '<div class="muted">ë‹µë³€ ì—†ìŒ</div>';
      }
      
      // Render Standard Sources
      if (data.standard_search_sources && data.standard_search_sources.length > 0) {
        standardSourcesDiv.innerHTML = data.standard_search_sources.map(s => `
          <div class="context-card" style="margin-bottom: 8px; padding: 10px;">
            <div class="badge">${s.type}</div>
            <div class="small" style="margin-top: 6px;">${s.title?.substring(0, 240) || 'N/A'}...</div>
          </div>
        `).join('');
      } else {
        standardSourcesDiv.innerHTML = '<div class="muted">ê²°ê³¼ ì—†ìŒ</div>';
      }
      
      // Render HyDE Sources
      if (data.sources && data.sources.length > 0) {
        hydeSourcesDiv.innerHTML = data.sources.map(s => `
          <div class="context-card" style="margin-bottom: 8px; padding: 10px;">
            <div class="badge">${s.type}</div>
            <div class="small" style="margin-top: 6px;">${s.title?.substring(0, 240) || 'N/A'}...</div>
          </div>
        `).join('');
      } else {
        hydeSourcesDiv.innerHTML = '<div class="muted">ê²°ê³¼ ì—†ìŒ</div>';
      }
      
      // Render Statistics
      const standardCount = data.standard_search_sources?.length || 0;
      const hydeCount = data.sources?.length || 0;
      const overlap = calculateOverlap(
        data.standard_search_sources?.map(s => s.id) || [],
        data.sources?.map(s => s.id) || []
      );
      
      abTestStatsDiv.innerHTML = `
        <div class="small">
          <strong>ğŸ“ˆ ê²€ìƒ‰ ê²°ê³¼ ë¹„êµ:</strong><br>
          â€¢ ì¼ë°˜ ê²€ìƒ‰: ${standardCount}ê°œ ë¬¸ì„œ<br>
          â€¢ HyDE ê²€ìƒ‰: ${hydeCount}ê°œ ë¬¸ì„œ<br>
          â€¢ ì¤‘ë³µ ë¬¸ì„œ: ${overlap}ê°œ<br>
          â€¢ HyDEë§Œ ì°¾ì€ ë¬¸ì„œ: ${hydeCount - overlap}ê°œ<br>
          â€¢ ì¼ë°˜ ê²€ìƒ‰ë§Œ ì°¾ì€ ë¬¸ì„œ: ${standardCount - overlap}ê°œ
        </div>
      `;
    }

    function calculateOverlap(arr1, arr2) {
      const set1 = new Set(arr1);
      const set2 = new Set(arr2);
      let count = 0;
      set1.forEach(item => {
        if (set2.has(item)) count++;
      });
      return count;
    }

    queryForm.addEventListener('submit', handleSearch);

    // Handle example buttons
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        queryInput.value = btn.textContent;
        handleSearch(new Event('submit'));
      });
    });

    fetchGraph();
  </script>
</body>
</html>
